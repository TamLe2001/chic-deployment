name: Deploy to Raspberry Pi 5

on:
  push:
    branches:
      - main
  workflow_dispatch:
  repository_dispatch:
    types: [frontend_submodule_update, backend_submodule_update]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Tailscale
        run: |
          # Install Tailscale
          curl -fsSL https://tailscale.com/install.sh | sh
          
          # Start Tailscale with auth key
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTHKEY }} --ssh

      - name: Wait for Tailscale connection
        run: |
          # Wait for Tailscale to be ready
          for i in {1..30}; do
            if sudo tailscale status > /dev/null 2>&1; then
              echo "Tailscale connected!"
              sudo tailscale status
              break
            fi
            echo "Waiting for Tailscale connection... ($i/30)"
            sleep 2
          done

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.RASPBERRY_PI_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy to Raspberry Pi
        env:
          RASPBERRY_PI_HOST: ${{ secrets.RASPBERRY_PI_HOST }}
          RASPBERRY_PI_USER: ${{ secrets.RASPBERRY_PI_USER }}
        run: |
          ssh -o StrictHostKeyChecking=no $RASPBERRY_PI_USER@$RASPBERRY_PI_HOST << 'ENDSSH'
            # Navigate to project directory
            cd ~/chic-deployment || exit 1
            
            # Pull latest changes
            git pull origin main
            
            # Update submodules
            git submodule update --init --recursive
            
            # Pull latest images and rebuild (while old containers still running)
            sudo docker compose pull
            sudo docker compose build --no-cache
            
            # Stop existing containers
            sudo docker compose down
            
            # Start new services immediately
            sudo docker compose up -d
            
            # Clean up old images
            sudo docker image prune -f
            
            # Show running containers
            sudo docker compose ps
          ENDSSH

      - name: Verify Deployment
        env:
          RASPBERRY_PI_HOST: ${{ secrets.RASPBERRY_PI_HOST }}
          RASPBERRY_PI_USER: ${{ secrets.RASPBERRY_PI_USER }}
        run: |
          ssh -o StrictHostKeyChecking=no $RASPBERRY_PI_USER@$RASPBERRY_PI_HOST << 'ENDSSH'
            cd ~/chic-deployment
            sudo docker compose ps
            echo "Deployment completed successfully!"
          ENDSSH

      - name: Cleanup
        if: always()
        run: |
          sudo tailscale down || true
